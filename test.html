<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StrongDog XP — Test</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico" />
    <style>
      :root {
        --ff: "Nunito", Arial, sans-serif;
        --bg: #2e2e2e;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: var(--ff);
        margin: 0;
        background: var(--bg);
        color: #fff;
      }
      .navbar {
        background: #333;
        color: #fff;
        padding: 12px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      .menu-icon {
        font-size: 2rem;
        cursor: pointer;
      }
      .logo {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        color: #fff;
        font-weight: 800;
        text-decoration: none;
      }
      .logo .xp {
        color: orange;
      }
      .search-container {
        position: relative;
      }
      .search-bar {
        padding: 0.7rem 1rem;
        border: none;
        border-radius: 12px;
        width: 280px;
        background: rgba(0, 0, 0, 0.35);
        color: #fff;
      }
      .search-results {
        position: absolute;
        right: 0;
        top: 56px;
        background: rgba(30, 30, 30, 0.95);
        border-radius: 12px;
        width: 320px;
        display: none;
        overflow: hidden;
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      }
      .search-results a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        text-decoration: none;
        color: #fff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .search-results img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 10px;
      }
      .games-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        padding: 10px;
      }
      .card-container {
        position: relative;
      }
      .card {
        display: block;
        width: 120px;
        aspect-ratio: 1/1;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 5px 18px rgba(0, 0, 0, 0.4);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }
      .card:hover {
        transform: scale(1.06) translateY(-6px);
        box-shadow: 0 10px 26px rgba(255, 98, 0, 0.35);
      }
      .card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .card figcaption {
        position: absolute;
        inset: auto 0 0 0;
        padding: 8px 6px;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
        text-align: center;
        font-weight: 700;
        opacity: 0;
        transform: translateY(100%);
        transition: all 0.25s;
      }
      .card:hover figcaption {
        opacity: 1;
        transform: translateY(0);
      }
      .card-buttons {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 6px;
      }
      .card-buttons button {
        background: transparent;
        border: none;
        font-size: 1.1rem;
        cursor: pointer;
      }
      .btn-check {
        color: #28a745;
      }
      .btn-delete {
        color: #dc3545;
      }
      .drawer {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 280px;
        background: #1f1f1f;
        transform: translateX(-100%);
        transition: transform 0.25s ease;
        z-index: 1100;
        padding: 20px 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .drawer.open {
        transform: translateX(0);
      }
      .drawer a {
        color: #fff;
        text-decoration: none;
        padding: 12px;
        border-radius: 10px;
        background: #2b2b2b;
      }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s ease;
        z-index: 1090;
      }
      .overlay.show {
        opacity: 1;
        pointer-events: auto;
      }
      .loader {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 40vh;
        font-weight: 700;
        letter-spacing: 0.5px;
        opacity: 0.85;
      }
      .hidden {
        display: none;
      }
      .busy {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.55);
        z-index: 2000;
      }
      .busy.show {
        display: flex;
      }
      .spinner {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: 6px solid rgba(255, 255, 255, 0.25);
        border-top-color: #fff;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      @media (max-width: 768px) {
        .card {
          width: 100px;
        }
      }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-functions-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBh-VnGiP4qZD0r14gfn9dr77GwtslpTqU",
        authDomain: "strongdog-auth.firebaseapp.com",
        databaseURL: "https://strongdog-auth-default-rtdb.firebaseio.com",
        projectId: "strongdog-auth",
        storageBucket: "strongdog-auth.appspot.com",
        messagingSenderId: "936276282572",
        appId: "1:936276282572:web:a802b7f609381ff9428669",
        measurementId: "G-0YLTCV2MMS",
      };
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      window.functions = firebase.functions();
    </script>
    <script type="module">
      import games from "./cards-data-test.js";

      const siteMapping = {
        "strongdog.onrender.com": [
          "https://strongdog.onrender.com",
          "https://strongdog2.onrender.com",
          "https://strongdog3.onrender.com",
          "https://strongdog4.onrender.com",
          "https://strongdog5.onrender.com",
        ],
        "strongdog2.onrender.com": [
          "https://strongdog.onrender.com",
          "https://strongdog2.onrender.com",
          "https://strongdog3.onrender.com",
          "https://strongdog4.onrender.com",
          "https://strongdog5.onrender.com",
        ],
        "stroongdog.netlify.app": [
          "https://stroongdog.netlify.app",
          "https://stroongdog2.netlify.app",
          "https://stroongdog3.netlify.app",
          "https://stroongdog4.netlify.app",
          "https://stroongdog5.netlify.app",
        ],
        "stroongdog2.netlify.app": [
          "https://stroongdog.netlify.app",
          "https://stroongdog2.netlify.app",
          "https://stroongdog3.netlify.app",
          "https://stroongdog4.netlify.app",
          "https://stroongdog5.netlify.app",
        ],
        "mathcord.netlify.app": [
          "https://mathcord.netlify.app",
          "https://mathcord2.netlify.app",
          "https://mathcord3.netlify.app",
          "https://mathcord4.netlify.app",
          "https://mathcord5.netlify.app",
        ],
      };
      function normalizeGameName(s) {
        return (s || "")
          .toLowerCase()
          .replace(/\s+/g, "")
          .replace(/[^a-z0-9]/g, "");
      }
      function cleanPath(p) {
        return (p || "").replace(/^\.?\//, "");
      }
      function resolveBaseForPage(page) {
        if (!page || page < 2) return "";
        const host = location.hostname;
        let matched = null;
        for (const key in siteMapping) {
          if (host.includes(key)) {
            matched = siteMapping[key];
            break;
          }
        }
        if (matched && matched[page - 1])
          return matched[page - 1].replace(/\/$/, "") + "/";
        if (page === 2) return "/strongdog2/";
        if (page === 3) return "/strongdog3/";
        if (page === 4) return "/strongdog4/";
        if (page === 5) return "/strongdog5/";
        return "/";
      }
      function isAbs(u) {
        return /^https?:\/\//i.test(u || "");
      }
      function resolveHref(href, page) {
        const s = cleanPath(href);
        if (isAbs(s)) return s;
        return resolveBaseForPage(page) + s;
      }
      function resolveImg(imgSrc, page) {
        const s = cleanPath(imgSrc);
        if (isAbs(s)) return s;
        const base = resolveBaseForPage(page);
        return base + (s.startsWith("img/") ? s : "img/" + s);
      }
      const disabledSet = new Set();
      let dataReady = false;
      function makeCard(g) {
        const to = resolveHref(g.href, g.page);
        const img = resolveImg(g.imgSrc, g.page);
        const id = normalizeGameName(g.name);
        return `
<div class="card-container" data-game-id="${id}">
  <a href="${to}" class="card"><img loading="lazy" src="${img}" alt="${g.name}"><figcaption>${g.name}</figcaption></a>
  <div class="card-buttons">
    <button class="btn-check" data-game-name="${g.name}" data-game-id="${id}" title="Approve">&#10003;</button>
    <button class="btn-delete" data-game-name="${g.name}" data-game-id="${id}" title="Report">&#10005;</button>
  </div>
</div>`;
      }
      function filterGames(q) {
        let list = games.filter(
          (g) => !disabledSet.has(normalizeGameName(g.name))
        );
        if (!q) return list;
        const s = q.toLowerCase().trim();
        return list.filter((g) => g.name.toLowerCase().includes(s));
      }
      function renderAll(list) {
        allGrid.innerHTML = list.map(makeCard).join("");
        wireButtons();
      }
      function renderSearch(q) {
        if (!dataReady) {
          searchBox.style.display = "none";
          searchBox.innerHTML = "";
          return;
        }
        const results = filterGames(q).slice(0, 12);
        if (!q || results.length === 0) {
          searchBox.style.display = "none";
          searchBox.innerHTML = "";
          return;
        }
        searchBox.innerHTML = results
          .map(
            (g) =>
              `<a href="${resolveHref(g.href, g.page)}"><img src="${resolveImg(
                g.imgSrc,
                g.page
              )}"><span>${g.name}</span></a>`
          )
          .join("");
        searchBox.style.display = "block";
      }
      function findCanonicalNameById(id) {
        const m = games.find((g) => normalizeGameName(g.name) === id);
        return m ? m.name : null;
      }
      function setBusy(on) {
        busy.classList.toggle("show", on);
        document
          .querySelectorAll(".btn-check,.btn-delete")
          .forEach((b) => (b.disabled = on));
      }
      function wireButtons() {
        document.querySelectorAll(".btn-check").forEach(
          (b) =>
            (b.onclick = async (e) => {
              const btn = e.currentTarget;
              const id = btn.dataset.gameId;
              const canonical = findCanonicalNameById(id);
              const nameToUse = canonical || btn.dataset.gameName;
              try {
                setBusy(true);
                const fn = firebase
                  .functions()
                  .httpsCallable("approveGameCallable");
                await fn({ gameName: nameToUse.trim() });
                await firebase
                  .firestore()
                  .collection("cards")
                  .add({ gameName: nameToUse, disable: true });
                btn.closest(".card-container").remove();
              } catch (err) {
                alert(`Error approving ${nameToUse}: ${err.message}`);
              } finally {
                setBusy(false);
              }
            })
        );
        document.querySelectorAll(".btn-delete").forEach(
          (b) =>
            (b.onclick = async (e) => {
              const btn = e.currentTarget;
              const id = btn.dataset.gameId;
              const canonical = findCanonicalNameById(id);
              const nameToUse = canonical || btn.dataset.gameName;
              const issue = prompt(`What was the issue with ${nameToUse}?`);
              if (!issue) return;
              try {
                setBusy(true);
                await fetch(
                  "https://script.google.com/macros/s/AKfycbxif7cZdOCWutbiue1m9sSYrH6VKY9VIVnEQDKnZOnJEsSO_cPi1pAU60mxPW8VWpzO/exec",
                  {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      timestamp: new Date().toISOString(),
                      gameName: nameToUse,
                      issue,
                    }),
                  }
                );
                await firebase
                  .firestore()
                  .collection("cards")
                  .add({ gameName: nameToUse, disable: true });
                btn.closest(".card-container").remove();
              } catch (err) {
                alert(`Error reporting ${nameToUse}: ${err.message}`);
              } finally {
                setBusy(false);
              }
            })
        );
      }
      function subscribeDisabled() {
        firebase
          .firestore()
          .collection("cards")
          .onSnapshot((s) => {
            disabledSet.clear();
            s.forEach((doc) => {
              const d = doc.data() || {};
              if (d.disable)
                disabledSet.add(normalizeGameName(d.gameName || ""));
            });
            dataReady = true;
            loader.classList.add("hidden");
            allGrid.classList.remove("hidden");
            searchInput.disabled = false;
            renderAll(filterGames(""));
          });
      }
      const allGrid = document.getElementById("allGame");
      const searchInput = document.getElementById("searchInput");
      const searchBox = document.getElementById("searchResults");
      const drawer = document.getElementById("drawer");
      const overlay = document.getElementById("overlay");
      const menuIcon = document.getElementById("menuIcon");
      const loader = document.getElementById("loader");
      const busy = document.getElementById("busy");
      document.addEventListener("DOMContentLoaded", () => {
        allGrid.classList.add("hidden");
        searchInput.disabled = true;
        subscribeDisabled();
        searchInput.addEventListener("input", (e) =>
          renderSearch(e.target.value)
        );
        document.addEventListener("click", (e) => {
          if (!searchBox.contains(e.target) && e.target !== searchInput)
            searchBox.style.display = "none";
        });
        function toggleMenu(open) {
          drawer.classList.toggle("open", open);
          overlay.classList.toggle("show", open);
        }
        menuIcon.addEventListener("click", () =>
          toggleMenu(!drawer.classList.contains("open"))
        );
        overlay.addEventListener("click", () => toggleMenu(false));
        document
          .querySelectorAll(".drawer a")
          .forEach((a) => a.addEventListener("click", () => toggleMenu(false)));
      });
    </script>
  </head>
  <body>
    <div
      id="secretLink"
      style="
        position: absolute;
        top: 10px;
        right: 10px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 1000;
      "
      onclick="location.href='secret-menu.html'"
    ></div>
    <div class="navbar">
      <div class="menu-icon" id="menuIcon">&#9776;</div>
      <a href="index.html" class="logo">StrongDog<span class="xp">XP</span></a>
      <div class="search-container">
        <input
          type="text"
          class="search-bar"
          placeholder="Search for games…"
          id="searchInput"
          autocomplete="off"
        />
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>
    <aside class="drawer" id="drawer">
      <a href="index.html">Home</a>
      <a href="test.html">Moderate (Test)</a>
      <a href="secret-menu.html">Secret</a>
    </aside>
    <div class="overlay" id="overlay"></div>
    <div id="loader" class="loader">Loading games…</div>
    <div id="busy" class="busy">
      <div class="spinner" aria-label="Loading"></div>
    </div>
    <h2 style="text-align: center"><strong>All</strong></h2>
    <div class="games-grid" id="allGame"></div>
  </body>
</html>